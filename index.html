<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BBET Filter v5.1 ‚Äî Front-only (AutoSync JSON)</title>
<style>
  :root{
    --bg:#0f172a;--fg:#e2e8f0;--mut:#94a3b8;--line:#23314f;
    --text:#0b1220;--outline:#22d3ee;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  main{max-width:1160px;margin:0 auto;padding:16px}
  .status{font-size:12px;color:var(--mut);margin-top:6px}
  .toolbar{display:grid;grid-template-columns: repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
  .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;height:40px;padding:0 12px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px}
  .btn.gray{background:#475569}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  th:first-child,td:first-child{width:46px}
  th.name,td.name{text-align:left}
  /* –∫–ª–µ—Ç–∫–∞ –∏—Å—Ö–æ–¥–∞ */
  td.pick{
    background:#ffffff;color:var(--text);font-weight:700;user-select:none;position:relative;
    transition: background-color 3.5s ease-in-out, box-shadow .2s ease;
  }
  td.pick .main{font-size:18px;line-height:1}
  td.pick .sub{display:block;font-size:11px;font-weight:600;opacity:.9;margin-top:2px}
  td.pick .delta{font-size:11px;opacity:.95;margin-top:2px}
  td.pick.active{outline:2px solid var(--outline);outline-offset:-2px}
  td.good{ color:#072214;}
  td.bad{  color:#2c0b0b;}
  .hint{font-size:12px;color:#9fb3d9;margin-top:8px}
  .muted{color:var(--mut)}
  textarea{width:100%;min-height:130px;background:#0b1427;border:1px solid var(--line);color:#e2e8f0;border-radius:10px;padding:8px 10px}
  .bottom{display:grid;grid-template-columns:1fr;gap:8px;margin-top:12px}
</style>
</head>
<body>
<header>‚ö° BBET Filter v5.1 ‚Äî ‚ÄúJackpot Confidence Mapping‚Äù (Front-only)</header>
<main>

<div class="status" id="conn">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>

<div class="toolbar">
  <button class="btn" id="btnBuild">‚öôÔ∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
  <button class="btn gray" id="btnCsv">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
  <button class="btn gray" id="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<table id="grid">
  <thead>
    <tr>
      <th>#</th><th class="name">–ú–∞—Ç—á</th><th>1</th><th>X</th><th>2</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="hint">–ü–æ–¥—Å–≤–µ—Ç–∫–∞: üü© —á–µ–º –∑–µ–ª–µ–Ω–µ–µ ‚Äî —Ç–µ–º –≤—ã—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (value + —Å–æ–≥–ª–∞—Å–∏–µ —Ä—ã–Ω–∫–∞). ‚ö™ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ. üü• –∏–∑–±–µ–≥–∞—Ç—å. –ù–∞–≤–µ–¥–∏ ‚Äî —É–≤–∏–¥–∏—à—å –∫—Ä–∞—Ç–∫—É—é –ø—Ä–∏—á–∏–Ω—É. –ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä (—Å–∏–Ω—è—è —Ä–∞–º–∫–∞).</div>

<div class="bottom">
  <textarea id="out" placeholder="–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–¥–∏–Ω –∫—É–ø–æ–Ω (1;X;2;...) ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ ¬´–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å¬ª."></textarea>
  <div id="stats" class="muted"></div>
  <div id="jackpot" class="muted"></div>
</div>

</main>

<script>
/* ===== helpers ===== */
const el = id => document.getElementById(id);
const tbody = document.querySelector('#grid tbody');
const clamp01 = x => Math.max(0, Math.min(1, x));

/* ===== config ===== */
const CONFIG = {
  // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–æ—Å—Ç–∞–≤–∏–ª–∏ 5 –º–∏–Ω—É—Ç –∫–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ)
  refreshMs: 5*60*1000,
  // –ø–æ—Ä–æ–≥–∏ value (—Ä–∞–∑–Ω–∏—Ü–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π —Ä—ã–Ω–∫–∞ –∏ –º–æ–¥–µ–ª–∏)
  thrGreenDelta: 0.05,
  thrRedDelta:  -0.05,
  thrNeutralAbs: 0.03,
  // —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ
  dataUrl: 'bbet_data.json',
  // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π
  matches: 15,
  K:{14:12,13:64,12:210,11:585,10:1365,9:4096}
};

/* ===== state ===== */
let data = null;          // —Å—ã—Ä–æ–π JSON
let probsMarket=[];       // [%] Betfair/exchange
let probsModel=[];        // [%] Pinnacle/book
let matchNames=[];        // ["Team A ‚Äì Team B"]
let lastSnapshot=[];      // –ø—Ä–æ—à–ª—ã–µ —Ü–µ–Ω—ã –¥–ª—è momentum
let snapshot=[];          // —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã (odds)

/* ===== fetch & prepare ===== */
async function loadData(){
  try{
    const r = await fetch(CONFIG.dataUrl, {cache:'no-store'});
    const j = await r.json();
    return j;
  }catch(e){
    // fallback –¥–µ–º–æ
    const make = i=>{
      const base = 2.2+Math.random()*0.6;
      const home = (base + (Math.random()*0.6-0.3));
      const draw = (3.0  + (Math.random()*0.5-0.25));
      const away = (base + (Math.random()*0.6-0.3));
      const ex   = {home:home*0.98, draw:draw*1.02, away:away*1.05};
      return {
        home:`Team ${i+1}A`, away:`Team ${i+1}B`,
        bookmaker:{home,draw,away},
        exchange:{home:ex.home,draw:ex.draw,away:ex.away},
        notes:["demo","volatility low","form +"]
      };
    };
    return {updated:new Date().toISOString(), matches:Array.from({length:CONFIG.matches},(_,i)=>make(i))};
  }
}

function oddsToProbs(o1,oX,o2){
  const p1=1/o1, pX=1/oX, p2=1/o2;
  const s=p1+pX+p2; return [p1/s,pX/s,p2/s];
}

function prepare(j){
  data = j;
  probsMarket=[]; probsModel=[]; matchNames=[]; snapshot=[];
  (j.matches||[]).slice(0,CONFIG.matches).forEach(m=>{
    const oM = m.exchange||m.market||m.bookmaker; // –µ—Å–ª–∏ –Ω–µ—Ç, –≤–æ–∑—å–º—ë–º —á—Ç–æ –µ—Å—Ç—å
    const oB = m.bookmaker||m.model||m.exchange;
    const [p1m,pXm,p2m] = oddsToProbs(oM.home,oM.draw,oM.away).map(x=>x*100);
    const [p1b,pXb,p2b] = oddsToProbs(oB.home,oB.draw,oB.away).map(x=>x*100);
    probsMarket.push([p1m,pXm,p2m]);
    probsModel.push([p1b,pXb,p2b]);
    matchNames.push(`${m.home} ‚Äî ${m.away}`);
    snapshot.push([oM.home,oM.draw,oM.away]);
  });
  if(!lastSnapshot.length) lastSnapshot = snapshot.map(r=>[...r]);
}

/* ===== analytics ===== */
function momentum(i,j){
  const prev = lastSnapshot[i]?.[j], cur = snapshot[i]?.[j];
  if(!prev||!cur) return 0;
  return Math.log(cur/prev); // <0 –ø–∞–¥–µ–Ω–∏–µ (—Ö–æ—Ä–æ—à–æ), >0 —Ä–æ—Å—Ç (–ø–ª–æ—Ö–æ)
}
function fmtPct(x){ return Math.round(x)+'%'; }
function fmtDelta(d){ const v=d*100; return (v>=0?'+':'')+v.toFixed(1)+'%'; }

function cellClassAndStyle(i,j){
  const mk=(probsMarket[i]?.[j]||33)/100;
  const md=(probsModel [i]?.[j]||33)/100;
  const d = mk-md;
  const mom = momentum(i,j);

  // –∑–µ–ª—ë–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –¥–µ–ª—å—Ç–µ, –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç |d|
  if(d>=CONFIG.thrGreenDelta){
    const power = clamp01((d-0.05)/0.15); // 0..1
    const light = clamp01(0.92 - power*0.35);
    return {cls:'pick good', style:`background-color:hsl(158deg,70%,${Math.round(light*100)}%);`, badge:'üü©', tip:`Value: ${fmtDelta(d)} ¬∑ momentum ${mom.toFixed(3)}`};
  }
  // –∫—Ä–∞—Å–Ω–∞—è ‚Äî –º–∏–Ω—É—Å EV –ª–∏–±–æ —Ä–æ—Å—Ç —Ü–µ–Ω—ã
  if(d<=CONFIG.thrRedDelta || mom>0.02){
    const inten = clamp01(Math.max(-d,0.05)/0.15);
    const light = clamp01(0.95 - inten*0.35);
    return {cls:'pick bad', style:`background-color:hsl(0deg,75%,${Math.round(light*100)}%);`, badge:'üü•', tip:`Risk: ${fmtDelta(d)} ¬∑ momentum ${mom.toFixed(3)}`};
  }
  // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
  return {cls:'pick', style:'background-color:#ffffff;', badge:'‚ö™', tip:`Neutral: ${fmtDelta(d)} ¬∑ momentum ${mom.toFixed(3)}`};
}

/* ===== UI render ===== */
let locked={}; // {row:'1'|'X'|'2'}
function render(){
  tbody.innerHTML='';
  for(let i=0;i<probsMarket.length;i++){
    const tr=document.createElement('tr');

    const cIdx=document.createElement('td'); cIdx.textContent=(i+1);
    const cName=document.createElement('td'); cName.className='name'; cName.textContent=matchNames[i]||`–ú–∞—Ç—á ${i+1}`;
    tr.appendChild(cIdx); tr.appendChild(cName);

    ['1','X','2'].forEach((lab,idx)=>{
      const td=document.createElement('td');
      const mk=probsMarket[i]?.[idx]??33;
      const md=probsModel [i]?.[idx]??33;
      const d=(mk-md)/100;
      const {cls,style,badge,tip}=cellClassAndStyle(i,idx);
      td.className=cls;
      td.setAttribute('style',style);
      if(locked[i]===lab) td.classList.add('active');
      td.title = `${matchNames[i]}\n${lab}: market ${fmtPct(mk)} vs model ${fmtPct(md)}\n${tip}`;
      td.innerHTML = `
        <div class="main">${lab} ‚Äî ${fmtPct(mk)}</div>
        <span class="sub">–º–æ–¥–µ–ª—å ${fmtPct(md)}</span>
        <div class="delta">${badge} Œî ${fmtDelta(d)}</div>
      `;
      td.onclick=()=>{ delete locked[i]; if(!td.classList.contains('active')) locked[i]=lab; render(); };
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  }
  updateSummary();
}
function updateSummary(){
  let greens=0, reds=0, total=0, confSum=0;
  for(let i=0;i<probsMarket.length;i++){
    for(let j=0;j<3;j++){
      total++;
      const mk=(probsMarket[i][j])/100, md=(probsModel[i][j])/100, d=mk-md, mom=momentum(i,j);
      const isG = d>=CONFIG.thrGreenDelta && mom<=0.02;
      const isR = d<=CONFIG.thrRedDelta || mom>0.02;
      if(isG) greens++; if(isR) reds++;
      const conf = clamp01(Math.max(0,d)/0.2); // –≥—Ä—É–±–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å 0..1
      confSum+=conf;
    }
  }
  const jackpot = Math.round((confSum/total)*100);
  el('jackpot').innerHTML = `üí∞ Jackpot Confidence: <b>${jackpot}%</b> ‚Ä¢ –ó–µ–ª—ë–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤: <b>${greens}</b> –∏–∑ <b>${total}</b> ‚Ä¢ –ö—Ä–∞—Å–Ω—ã—Ö: <b>${reds}</b>`;
  let msg='–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.';
  if(greens>=30) msg='üî• Core Confidence Sequence ‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è.';
  if(greens>=36) msg='üí∞ Jackpot Alignment Detected ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–ª–∏–∑–∫–∞ –∫ –∏–¥–µ–∞–ª—å–Ω–æ–π.';
  el('stats').textContent=msg;
}

/* ===== coupons ===== */
function combineOrdered(sets, limit){
  let res=[[]];
  for(const s of sets){
    const next=[];
    for(const r of res){
      for(const v of s){
        const arr=r.concat(v); next.push(arr);
        if(limit && next.length>=limit){ res=next; break; }
      }
      if(limit && next.length>=limit) break;
    }
    res=next;
    if(limit && res.length>=limit) break;
  }
  return res;
}
function setsFromColors(){
  const sets=[];
  for(let i=0;i<probsMarket.length;i++){
    if(locked[i]){ sets.push([locked[i]]); continue; }
    const mk=probsMarket[i], md=probsModel[i];
    const delta=[mk[0]-md[0], mk[1]-md[1], mk[2]-md[2]].map(x=>x/100);
    const order=['1','X','2'].map((lab,idx)=>({lab,d:delta[idx]})).sort((a,b)=>b.d-a.d);

    // –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫–ª–∞—Å—Å—É
    const cls=[0,1,2].map(idx=>cellClassAndStyle(i,idx).cls);
    if(cls.some(c=>c.includes('good'))){
      const best = order.find(o=>cellClassAndStyle(i, o.lab==='1'?0:o.lab==='X'?1:2).cls.includes('good')) || order[0];
      sets.push([best.lab]);
    }else if(cls.every(c=>c.includes('bad'))){
      sets.push([order[0].lab]);
    }else{
      sets.push([order[0].lab, order[1].lab]); // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ ‚Äî –¥–≤–æ–π–Ω–∏–∫
    }
  }
  return sets;
}
function buildCoupons(){
  const sets=setsFromColors();
  let theoretical=1; for(const s of sets) theoretical*=s.length;
  const cat=13, k=CONFIG.K[cat]||64;
  const target=Math.max(1, Math.floor(theoretical/k));
  const raw=combineOrdered(sets, Math.min(target*3, 25000));
  const coupons=raw.slice(0,target);
  el('out').value = coupons.map((c,i)=>`${i+1};${c.join(';')}`).join('\n') || '(–Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –º–∞–ª–æ —Å–∏–≥–Ω–∞–ª–æ–≤/—Å–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–æ)';
}
function exportCsv(){
  const t=el('out').value.trim(); if(!t){ alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—É–ø–æ–Ω—ã'); return; }
  const blob=new Blob([t],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='bbet_coupons.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== loop ===== */
async function tick(){
  el('conn').textContent='üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶';
  const j = await loadData();
  prepare(j);
  render();
  lastSnapshot = snapshot.map(r=>[...r]);
  const t=new Date();
  el('conn').textContent=`üü¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${t.toLocaleTimeString('ru-RU')} ‚Ä¢ –°–ª–µ–¥—É—é—â–µ–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç`;
}

/* ===== init ===== */
(function init(){
  // —Å—Ç–∞—Ä—Ç
  tick();
  // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ JSON –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî –ø–æ–¥—Ö–≤–∞—Ç–∏–º)
  setInterval(tick, CONFIG.refreshMs);

  // –∫–Ω–æ–ø–∫–∏
  el('btnBuild').onclick=buildCoupons;
  el('btnCsv').onclick=exportCsv;
  el('btnClear').onclick=()=>{ locked={}; el('out').value=''; render(); };
})();
</script>
</body>
</html>

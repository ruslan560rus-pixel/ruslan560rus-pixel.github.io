<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‚ö° BBET Filter v4.6a ‚Äî Smart Totobrief Mode</title>
<style>
  :root{--bg:#0f172a;--fg:#e2e8f0;--mut:#94a3b8;--line:#23314f;--btn:#2563eb;--ok:#16a34a;--mid:#ca8a04;--bad:#dc2626;--sel:#22d3ee}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600}
  main{max-width:980px;margin:0 auto;padding:16px}
  .muted{color:var(--mut);margin-top:4px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{font:inherit}
  input,select,textarea{background:#0b1427;border:1px solid var(--line);color:var(--fg);border-radius:8px;padding:8px}
  textarea{width:100%;min-height:110px}
  button{background:var(--btn);color:#fff;border:none;border-radius:8px;height:38px;padding:0 12px;cursor:pointer}
  button.gray{background:#475569}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:center}
  th:first-child,td:first-child{text-align:left;width:36px}
  td.pick{cursor:pointer;color:#fff;font-weight:600}
  td.pick.sel{outline:2px solid var(--sel)}
  .g{background:var(--ok)} .y{background:var(--mid)} .r{background:var(--bad)}
  #out{width:100%;min-height:120px;margin-top:10px}
  #stats{margin-top:8px;color:var(--mut)}
</style>
</head>
<body>
<header>‚ö° BBET Filter v4.6a ‚Äî Smart Totobrief Mode</header>
<main>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div class="row">
  <input id="draw" type="number" placeholder="‚Ññ —Ç–∏—Ä–∞–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1484)" style="width:200px">
  <button id="btnLoad">üì° –ò–º–ø–æ—Ä—Ç —Å TotoBrief</button>
  <span class="muted">–∏–ª–∏ –≤—Å—Ç–∞–≤—å HTML/CSV –Ω–∏–∂–µ:</span>
</div>
<textarea id="raw" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É Totobrief (HTML) –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ CSV —Å —Ç—Ä–µ–º—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ –Ω–∞ –º–∞—Ç—á..."></textarea>

<div class="row" style="margin-top:8px">
  <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: 
    <select id="cat">
      <option>15</option><option>14</option><option selected>13</option>
      <option>12</option><option>11</option><option>10</option><option>9</option>
    </select>
  </span>
  <span>–ü1 –æ—Ç <input id="min1" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="max1" type="number" min="0" max="15" style="width:64px"></span>
  <span>–• –æ—Ç <input id="minX" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="maxX" type="number" min="0" max="15" style="width:64px"></span>
  <span>–ü2 –æ—Ç <input id="min2" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="max2" type="number" min="0" max="15" style="width:64px"></span>
  <span style="margin-left:auto">–õ–∏–º–∏—Ç –≤—ã–≤–æ–¥–∞ <input id="limit" type="number" value="50000" style="width:100px"></span>
</div>

<div class="row" style="margin-top:8px">
  <button id="btnBuild">‚öôÔ∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω—ã</button>
  <button id="btnCopy" class="gray">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnCsv" class="gray">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –±—Ä–∏—Ñ–∞ -->
<table id="grid">
  <thead><tr><th>#</th><th>1</th><th>X</th><th>2</th></tr></thead>
  <tbody></tbody>
</table>

<textarea id="out" placeholder="–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–¥–∏–Ω –∫—É–ø–æ–Ω (1;X;2;...)."></textarea>
<div id="stats"></div>
</main>

<script>
/* ===== –£—Ç–∏–ª–∏—Ç—ã ===== */
const el = id => document.getElementById(id);
const tbody = document.querySelector('#grid tbody');
const color = v => v>=50?'g':(v>=35?'y':'r');
const toInt = v => {const n=parseInt(v,10);return Number.isFinite(n)?n:null;}
function rangesOk(picks, cfg){
  const c={1:0,X:0,2:0}; picks.forEach(v=>c[v]++);
  if(cfg.min1!=null && c[1]<cfg.min1) return false;
  if(cfg.max1!=null && c[1]>cfg.max1) return false;
  if(cfg.minX!=null && c.X<cfg.minX) return false;
  if(cfg.maxX!=null && c.X>cfg.maxX) return false;
  if(cfg.min2!=null && c[2]<cfg.min2) return false;
  if(cfg.max2!=null && c[2]>cfg.max2) return false;
  return true;
}

/* ===== –ü–∞—Ä—Å–µ—Ä—ã Totobrief ===== */
// 1) HTML Totobrief
function parseHTML(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const rows = [...doc.querySelectorAll('tr')].slice(1);
  const data=[];
  for(const r of rows){
    const t=[...r.querySelectorAll('td')].map(x=>x.textContent.trim().replace(',','.'));
    const nums=t.map(x=>parseFloat(x)).filter(n=>Number.isFinite(n)&&n>=0&&n<=100);
    if(nums.length>=3){ data.push(nums.slice(0,3)); if(data.length===15) break; }
  }
  return data;
}
// 2) CSV/—Ç–µ–∫—Å—Ç
function parseCSV(txt){
  const lines = txt.trim().split(/\r?\n/);
  const data=[];
  for(const l of lines){
    const nums=(l.match(/(\d+(\.\d+)?)/g)||[]).map(x=>+x);
    if(nums.length>=3){ data.push(nums.slice(0,3)); if(data.length===15) break; }
  }
  return data;
}
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
function parseRaw(txt){
  if(!txt) return [];
  if(txt.includes('<table')||txt.includes('<tr')) return parseHTML(txt);
  return parseCSV(txt);
}

/* ===== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏ ===== */
function renderGrid(arr){
  tbody.innerHTML='';
  for(let i=0;i<15;i++){
    const row=arr[i]||[33,33,34];
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="pick ${color(row[0])}" data-col="1">${row[0]}</td>
      <td class="pick ${color(row[1])}" data-col="X">${row[1]}</td>
      <td class="pick ${color(row[2])}" data-col="2">${row[2]}</td>
    `;
    tbody.appendChild(tr);
  }
  bindPicking();
}
function bindPicking(){
  tbody.querySelectorAll('td.pick').forEach(td=>{
    td.onclick=()=>{
      td.classList.toggle('sel');
    };
  });
}

/* ===== –ò–º–ø–æ—Ä—Ç —Å TotoBrief (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –±–µ–∑ CORS) ===== */
async function loadTB(draw){
  const url=`https://r.jina.ai/http://totobrief.ru/results/bbet/${draw}`;
  try{
    const txt = await fetch(url,{cache:'no-store'}).then(r=>r.text());
    // –≤—ã—Ç–∞—â–∏–º –ø–µ—Ä–≤—ã–µ 45 —á–∏—Å–µ–ª 0..100 (–ø–æ 3 –Ω–∞ –º–∞—Ç—á)
    const nums = [...txt.matchAll(/(?:^|[^0-9])(100|[1-9]?\d)(?=%?)(?:[^0-9]|$)/g)].map(m=>+m[1]);
    if(nums.length<45) throw 0;
    const data=[]; for(let i=0;i<15;i++) data.push([nums[i*3],nums[i*3+1],nums[i*3+2]]);
    renderGrid(data);
    el('raw').value='';
  }catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å. –í—Å—Ç–∞–≤—å HTML/CSV –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ.'); }
}

/* ===== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—É–ø–æ–Ω–æ–≤ ===== */
function selectedSets(){
  // –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Å–æ–±–µ—Ä—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã; –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –≤—Å–µ —Ç—Ä–∏
  const sets=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const picks=[...tr.querySelectorAll('td.pick.sel')].map(td=>td.dataset.col);
    sets.push(picks.length?picks:['1','X','2']);
  });
  return sets;
}
function combine(sets, hardLimit){
  // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–º–Ω–æ–∂–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –≤–∑–æ—Ä–≤–∞—Ç—å—Å—è –ø–æ –ø–∞–º—è—Ç–∏
  let res=[[]];
  for(const s of sets){
    const next=[];
    for(const r of res){
      for(const v of s){
        const arr=r.concat(v);
        next.push(arr);
        if(hardLimit && next.length>hardLimit){ res=next; break; }
      }
      if(hardLimit && next.length>hardLimit) break;
    }
    res=next;
    if(hardLimit && res.length>hardLimit) break;
  }
  return res;
}
function targetByCategory(cat){
  // –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ü–µ–ª–∏ –ø–æ–∫—Ä—ã—Ç–∏—è (–º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å)
  const map={15:50000,14:25000,13:15000,12:8000,11:4000,10:2000,9:800};
  return map[cat]||5000;
}
function buildCoupons(){
  const cfg={
    min1:toInt(el('min1').value), max1:toInt(el('max1').value),
    minX:toInt(el('minX').value), maxX:toInt(el('maxX').value),
    min2:toInt(el('min2').value), max2:toInt(el('max2').value)
  };
  const cat = parseInt(el('cat').value,10);
  const hardLimit = Math.min(+el('limit').value||50000, 100000); // –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å
  const sets = selectedSets();

  // –≥—Ä—É–±–∞—è –≤–µ—Ä—Ö–Ω—è—è –æ—Ü–µ–Ω–∫–∞ (–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–ª–∏–Ω)
  const theoretical = sets.reduce((a,s)=>a*s.length,1);

  // —Å–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä—ë–º ¬´—Ö—Ä–µ–±–µ—Ç¬ª ‚Äî –ø–æ –æ–¥–Ω–æ–º—É –ª—É—á—à–µ–º—É –∏—Å—Ö–æ–¥—É (–≥–¥–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ)
  const greedy = sets.map(s=>{
    if(s.length===3) return ['1','X','2']; // –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–æ–±–æ–¥—É
    return s; // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä—É–∫–∞–º–∏ –æ—Ç—Ä–µ–∑–∞–ª ‚Äî —É–≤–∞–∂–∞–µ–º
  });

  // –±—ç–∫–µ–Ω–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: –∏—â–µ–º –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏
  const raw = combine(greedy, Math.min(hardLimit, targetByCategory(cat)*3));
  const filtered = raw.filter(r=>rangesOk(r,cfg));

  // –¥–æ–±–∏—Ä–∞–µ–º –¥–æ —Ü–µ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –µ—Å–ª–∏ –Ω–∞–¥–æ (—Å–ª–µ–≥–∫–∞ —Ä–∞—Å—à–∏—Ä–∏–º —Å–≤–æ–±–æ–¥—É —Ç–∞–º, –≥–¥–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
  let coupons = filtered.slice(0, targetByCategory(cat));
  if(coupons.length < targetByCategory(cat) && theoretical>filtered.length){
    const all = combine(sets, Math.min(hardLimit, targetByCategory(cat)*6)).filter(r=>rangesOk(r,cfg));
    coupons = all.slice(0, targetByCategory(cat));
  }

  // –≤—ã–≤–æ–¥
  const list = coupons.map((c,i)=>`${i+1};${c.join(';')}`).join('\n');
  el('out').value = list || '(–Ω–∏ –æ–¥–∏–Ω –∫—É–ø–æ–Ω –Ω–µ –ø–æ–ª—É—á–∏–ª—Å—è ‚Äî —Ä–∞—Å—à–∏—Ä—å –≤—ã–±–æ—Ä –∏–ª–∏ –æ—Å–ª–∞–±—å —Ñ–∏–ª—å—Ç—Ä—ã)';
  const count = coupons.length;
  const money = count * 30;
  const passPct = theoretical ? ((count/theoretical)*100).toFixed(2) : '0.00';
  el('stats').innerHTML = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è <b>${cat}</b> ‚Ä¢ –ö—É–ø–æ–Ω–æ–≤: <b>${count.toLocaleString('ru-RU')}</b> ‚Ä¢ –°—É–º–º–∞: <b>${money.toLocaleString('ru-RU')} ‚ÇΩ</b><br>–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ: <b>${theoretical.toLocaleString('ru-RU')}</b> ‚Ä¢ –í—ã–≤–µ–¥–µ–Ω–æ: <b>${passPct}%</b>`;
}

/* ===== –°–æ–±—ã—Ç–∏—è ===== */
el('btnLoad').onclick = ()=>{ const id=(el('draw').value||'').trim(); if(!id) return alert('–í–≤–µ–¥–∏ ‚Ññ —Ç–∏—Ä–∞–∂–∞'); loadTB(id); };
el('btnBuild').onclick = buildCoupons;
el('btnCopy').onclick = async()=>{
  const t=el('out').value.trim(); if(!t) return alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—É–ø–æ–Ω—ã');
  try{ await navigator.clipboard.writeText(t); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–±—Ä–∞—É–∑–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–ª –±—É—Ñ–µ—Ä)'); }
};
el('btnCsv').onclick = ()=>{
  const t=el('out').value.trim(); if(!t) return alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—É–ø–æ–Ω—ã');
  const blob = new Blob([t],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='bbet_coupons.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* ===== –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
(function init(){
  // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–∏—Ç HTML/CSV ‚Äî –ø–∞—Ä—Å–∏–º –∏ —Ä–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É
  el('raw').addEventListener('change',()=>{
    const data = parseRaw(el('raw').value||'');
    if(data.length){ renderGrid(data); }
  });
  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø—É—Å—Ç–∞—è —Å–µ—Ç–∫–∞
  renderGrid([]);
})();
</script>
</body>
</html>

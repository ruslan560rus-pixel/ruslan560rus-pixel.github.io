<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‚ö° BBET Filter v4.6b ‚Äî Adaptive Parser</title>
<style>
  :root{--bg:#0f172a;--fg:#e2e8f0;--mut:#94a3b8;--line:#23314f;--btn:#2563eb;--red:#dc2626;--sel:#22d3ee}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:600}
  main{max-width:980px;margin:0 auto;padding:16px}
  .muted{color:var(--mut);margin-top:4px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select,textarea{font:inherit}
  input,select,textarea{background:#0b1427;border:1px solid var(--line);color:var(--fg);border-radius:8px;padding:8px}
  textarea{width:100%;min-height:110px}
  button{background:var(--btn);color:#fff;border:none;border-radius:8px;height:38px;padding:0 12px;cursor:pointer}
  button.gray{background:#475569}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:center}
  th:first-child,td:first-child{text-align:left;width:36px}
  /* –±–µ–ª—ã–µ —è—á–µ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  td.pick{cursor:pointer;background:#ffffff;color:#111827;font-weight:600}
  /* –≤—ã–±—Ä–∞–Ω–Ω–∞—è = –∫—Ä–∞—Å–Ω–∞—è */
  td.pick.sel{background:var(--red);color:#fff;outline:2px solid var(--sel)}
  #out{width:100%;min-height:120px;margin-top:10px}
  #stats{margin-top:8px;color:var(--mut)}
  label.inline{display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>‚ö° BBET Filter v4.6b ‚Äî Adaptive Parser</header>
<main>

<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div class="row">
  <input id="draw" type="number" placeholder="‚Ññ —Ç–∏—Ä–∞–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1484)" style="width:200px">
  <button id="btnLoad">üì° –ò–º–ø–æ—Ä—Ç —Å TotoBrief</button>
  <span class="muted">–∏–ª–∏ –≤—Å—Ç–∞–≤—å HTML/CSV/—Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ:</span>
</div>
<textarea id="raw" placeholder="–í—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É Totobrief (HTML), CSV –∏–ª–∏ —Ç–µ–∫—Å—Ç –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ ‚Äî —Å–∫—Ä–∏–ø—Ç —Å–∞–º –Ω–∞–π–¥—ë—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã 1/X/2 –¥–ª—è 15 –º–∞—Ç—á–µ–π."></textarea>
<div class="row" style="margin-top:8px">
  <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: 
    <select id="cat">
      <option>15</option><option>14</option><option selected>13</option>
      <option>12</option><option>11</option><option>10</option><option>9</option>
    </select>
  </span>
  <span>–ü1 –æ—Ç <input id="min1" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="max1" type="number" min="0" max="15" style="width:64px"></span>
  <span>–• –æ—Ç <input id="minX" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="maxX" type="number" min="0" max="15" style="width:64px"></span>
  <span>–ü2 –æ—Ç <input id="min2" type="number" min="0" max="15" style="width:64px"> –¥–æ <input id="max2" type="number" min="0" max="15" style="width:64px"></span>
</div>

<div class="row" style="margin-top:6px">
  <label class="inline">–ù–µ –±–æ–ª–µ–µ –ø–æ–¥—Ä—è–¥ 1: <input id="st1" type="number" min="0" max="15" style="width:64px"></label>
  <label class="inline">–•: <input id="stX" type="number" min="0" max="15" style="width:64px"></label>
  <label class="inline">2: <input id="st2" type="number" min="0" max="15" style="width:64px"></label>
  <label class="inline"><input id="evenXon" type="checkbox"> –õ–∏–º–∏—Ç –• –Ω–∞ —á—ë—Ç–Ω—ã—Ö: </label>
  <input id="evenX" type="number" min="0" max="15" style="width:64px">
  <label class="inline"><input id="antiPattern" type="checkbox"> –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω 1,1,X,X</label>
  <span style="margin-left:auto">–õ–∏–º–∏—Ç –≤—ã–≤–æ–¥–∞ <input id="limit" type="number" value="50000" style="width:100px"></span>
</div>

<div class="row" style="margin-top:8px">
  <button id="btnBuild">‚öôÔ∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω—ã</button>
  <button id="btnCopy" class="gray">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnCsv" class="gray">üíæ –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –±—Ä–∏—Ñ–∞ -->
<table id="grid">
  <thead><tr><th>#</th><th>1</th><th>X</th><th>2</th></tr></thead>
  <tbody></tbody>
</table>

<textarea id="out" placeholder="–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–¥–∏–Ω –∫—É–ø–æ–Ω (1;X;2;...)."></textarea>
<div id="stats"></div>
</main>

<script>
/* ==== —É—Ç–∏–ª—ã ==== */
const el = id => document.getElementById(id);
const tbody = document.querySelector('#grid tbody');
const toInt = v => {const n=parseInt(v,10);return Number.isFinite(n)?n:null;};
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

/* ==== —Ñ–∏–ª—å—Ç—Ä—ã ==== */
function rangesOk(picks, cfg){
  const c={1:0,X:0,2:0}; picks.forEach(v=>c[v]++);
  if(cfg.min1!=null && c[1]<cfg.min1) return false;
  if(cfg.max1!=null && c[1]>cfg.max1) return false;
  if(cfg.minX!=null && c.X<cfg.minX) return false;
  if(cfg.maxX!=null && c.X>cfg.maxX) return false;
  if(cfg.min2!=null && c[2]<cfg.min2) return false;
  if(cfg.max2!=null && c[2]>cfg.max2) return false;
  // streak limits
  let s1=0,sx=0,s2=0,prev=null;
  for(const v of picks){
    if(v!==prev){s1=sx=s2=0;prev=v;}
    if(v==='1'){s1++; if(cfg.st1!=null && s1>cfg.st1) return false;}
    if(v==='X'){sx++; if(cfg.stX!=null && sx>cfg.stX) return false;}
    if(v==='2'){s2++; if(cfg.st2!=null && s2>cfg.st2) return false;}
  }
  // even X limit
  if(cfg.evenXon){
    let ex=0; for(let i=1;i<=picks.length;i++) if(i%2===0 && picks[i-1]==='X') ex++;
    if(cfg.evenX!=null && ex>cfg.evenX) return false;
  }
  // anti pattern 1,1,X,X
  if(cfg.anti){
    for(let i=0;i+3<picks.length;i++){
      const a=picks[i],b=picks[i+1],c2=picks[i+2],d=picks[i+3];
      if(a===b && c2===d && a!==c2) return false;
      if(a===b && c2===d && a===c2) return false; // 1,1,1,1 –∏ —Ç.–ø.
    }
  }
  return true;
}

/* ==== –ø–∞—Ä—Å–∏–Ω–≥ –≤—Ö–æ–¥–∞ ==== */
// HTML Totobrief
function parseHTML(html){
  const doc = new DOMParser().parseFromString(html,'text/html');
  const cells = [...doc.querySelectorAll('td,th')].map(x=>x.textContent.trim().replace(',','.'));
  const nums = cells.map(x=>parseFloat(x)).filter(n=>Number.isFinite(n)&&n>=0&&n<=100);
  return groupTo15x3(nums);
}
// CSV / —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –ø—Ä–∏–º–µ—Ä–µ)
function parseText(txt){
  const nums = (txt.replace(',', '.').match(/(?:^|[^0-9])(100|[1-9]?\d(?:\.\d+)?)(?=%?)(?!\d)/g)||[])
               .map(s=>parseFloat(s)).filter(n=>n>=0&&n<=100);
  return groupTo15x3(nums);
}
function groupTo15x3(nums){
  const data=[]; for(let i=0;i<45 && i<nums.length; i+=3){ data.push([nums[i],nums[i+1],nums[i+2]]); if(data.length===15) break; }
  return data;
}
function parseAny(txt){
  if(!txt) return [];
  if(txt.includes('<table')||txt.includes('<tr')||txt.includes('</td')) return parseHTML(txt);
  return parseText(txt);
}

/* ==== —Ç–∞–±–ª–∏—Ü–∞ ==== */
function renderGrid(arr){
  tbody.innerHTML='';
  for(let i=0;i<15;i++){
    const row=arr[i]||[33,33,34];
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="pick" data-col="1">${Math.round(row[0])}</td>
      <td class="pick" data-col="X">${Math.round(row[1])}</td>
      <td class="pick" data-col="2">${Math.round(row[2])}</td>
    `;
    tbody.appendChild(tr);
  }
  bindPicking();
}
function bindPicking(){
  tbody.querySelectorAll('td.pick').forEach(td=>{
    td.onclick=()=>{ td.classList.toggle('sel'); };
  });
}

/* ==== –∏–º–ø–æ—Ä—Ç –ø–æ –Ω–æ–º–µ—Ä—É —Ç–∏—Ä–∞–∂–∞ ==== */
async function loadTB(draw){
  const url=`https://r.jina.ai/http://totobrief.ru/results/bbet/${draw}`;
  try{
    const txt=await fetch(url,{cache:'no-store'}).then(r=>r.text());
    const data=parseHTML(txt);
    if(!data.length) throw 0;
    renderGrid(data);
    el('raw').value='';
  }catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å. –í—Å—Ç–∞–≤—å HTML/CSV/—Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.'); }
}

/* ==== –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—É–ø–æ–Ω–æ–≤ ==== */
function selectedSets(){
  const sets=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const picks=[...tr.querySelectorAll('td.pick.sel')].map(td=>td.dataset.col);
    sets.push(picks.length?picks:['1','X','2']);
  });
  return sets;
}
function combine(sets, hardLimit){
  let res=[[]];
  for(const s of sets){
    const next=[];
    for(const r of res){
      for(const v of s){
        const arr=r.concat(v); next.push(arr);
        if(hardLimit && next.length>hardLimit){ res=next; break; }
      }
      if(hardLimit && next.length>hardLimit) break;
    }
    res=next;
    if(hardLimit && res.length>hardLimit) break;
  }
  return res;
}
function targetByCategory(cat){
  const map={15:50000,14:25000,13:15000,12:8000,11:4000,10:2000,9:800};
  return map[cat]||5000;
}
function buildCoupons(){
  const cfg={
    min1:toInt(el('min1').value), max1:toInt(el('max1').value),
    minX:toInt(el('minX').value), maxX:toInt(el('maxX').value),
    min2:toInt(el('min2').value), max2:toInt(el('max2').value),
    st1:toInt(el('st1').value), stX:toInt(el('stX').value), st2:toInt(el('st2').value),
    evenXon:el('evenXon').checked, evenX:toInt(el('evenX').value),
    anti:el('antiPattern').checked
  };
  const cat=parseInt(el('cat').value,10);
  const limit=clamp(+el('limit').value||50000,1,100000);
  const sets=selectedSets();
  const theoretical=sets.reduce((a,s)=>a*s.length,1);

  // –ø–µ—Ä–≤–∏—á–Ω—ã–π –Ω–∞–±–æ—Ä
  const raw = combine(sets, Math.min(limit, targetByCategory(cat)*3));
  const filtered = raw.filter(r=>rangesOk(r,cfg));
  let coupons = filtered.slice(0, targetByCategory(cat));
  if(coupons.length < targetByCategory(cat) && theoretical>filtered.length){
    const all = combine(sets, Math.min(limit, targetByCategory(cat)*6)).filter(r=>rangesOk(r,cfg));
    coupons = all.slice(0, targetByCategory(cat));
  }

  const list=coupons.map((c,i)=>`${i+1};${c.join(';')}`).join('\n');
  el('out').value=list || '(–Ω–∏ –æ–¥–∏–Ω –∫—É–ø–æ–Ω –Ω–µ –ø–æ–ª—É—á–∏–ª—Å—è ‚Äî —Ä–∞—Å—à–∏—Ä—å –≤—ã–±–æ—Ä –∏–ª–∏ –æ—Å–ª–∞–±—å —Ñ–∏–ª—å—Ç—Ä—ã)';
  const count=coupons.length, money=count*30, pass=theoretical?((count/theoretical)*100).toFixed(2):'0.00';
  el('stats').innerHTML=`–ö–∞—Ç–µ–≥–æ—Ä–∏—è <b>${cat}</b> ‚Ä¢ –ö—É–ø–æ–Ω–æ–≤: <b>${count.toLocaleString('ru-RU')}</b> ‚Ä¢ –°—É–º–º–∞: <b>${money.toLocaleString('ru-RU')} ‚ÇΩ</b><br>–í–æ–∑–º–æ–∂–Ω—ã—Ö: <b>${theoretical.toLocaleString('ru-RU')}</b> ‚Ä¢ –î–æ–ª—è –≤—ã–≤–æ–¥–∞: <b>${pass}%</b>`;
}

/* ==== —Å–æ–±—ã—Ç–∏—è ==== */
el('btnLoad').onclick=()=>{const id=(el('draw').value||'').trim(); if(!id) return alert('–í–≤–µ–¥–∏ ‚Ññ —Ç–∏—Ä–∞–∂–∞'); loadTB(id);};
el('btnBuild').onclick=buildCoupons;
el('btnCopy').onclick=async()=>{
  const t=el('out').value.trim(); if(!t) return alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—É–ø–æ–Ω—ã');
  try{ await navigator.clipboard.writeText(t); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–±—Ä–∞—É–∑–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–ª –±—É—Ñ–µ—Ä)'); }
};
el('btnCsv').onclick=()=>{
  const t=el('out').value.trim(); if(!t) return alert('–°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫—É–ø–æ–Ω—ã');
  const blob=new Blob([t],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='bbet_coupons.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
el('raw').addEventListener('input',()=>{
  const data=parseAny(el('raw').value||''); if(data.length){ renderGrid(data); }
});

/* ==== —Å—Ç–∞—Ä—Ç ==== */
renderGrid([]); // –ø—É—Å—Ç–∞—è —Å–µ—Ç–∫–∞
</script>
</body>
</html>
